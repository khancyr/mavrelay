services:

  traefik:
    image: traefik:v3.6
    container_name: traefik
    restart: unless-stopped
    network_mode: "host"
    command:
      - --configFile=/traefik/traefik.yml
    volumes:
      - ./traefik/traefik.yml:/traefik/traefik.yml:ro
      - ./traefik/acme.json:/acme.json
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      - TRAEFIK_ACME_EMAIL=${TRAEFIK_ACME_EMAIL}
      - OVH_ENDPOINT=${OVH_ENDPOINT}
      - OVH_APPLICATION_KEY=${OVH_APPLICATION_KEY}
      - OVH_APPLICATION_SECRET=${OVH_APPLICATION_SECRET}
      - OVH_CONSUMER_KEY=${OVH_CONSUMER_KEY}
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.traefik.rule=Host(`${TRAEFIK_DOMAIN}`) && (PathPrefix(`/api`) || PathPrefix(`/dashboard`))"
      - "traefik.http.routers.traefik.entrypoints=websecure"
      - "traefik.http.routers.traefik.tls.certresolver=letsencrypt"
      - "traefik.http.routers.traefik.service=api@internal"
      - "traefik.http.routers.traefik-dashboard.rule=Host(`${TRAEFIK_DOMAIN}`) && PathPrefix(`/traefik`)"
      - "traefik.http.routers.traefik-dashboard.entrypoints=websecure"
      - "traefik.http.routers.traefik-dashboard.tls.certresolver=letsencrypt"
      - "traefik.http.routers.traefik-dashboard.service=api@internal"
      - "traefik.http.routers.traefik-dashboard.middlewares=traefik-dashboard-stripprefix"
      - "traefik.http.middlewares.traefik-dashboard-stripprefix.stripprefix.prefixes=/traefik"

  homepage:
    build:
      context: ./homepage
      dockerfile: homepage.Dockerfile
    container_name: homepage
    restart: unless-stopped
    network_mode: "host"
    depends_on:
      - mediamtx
      - mavlink-server
      - mavlink-camera-manager
      - cockpit
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.homepage.rule=Host(`${TRAEFIK_DOMAIN}`) && PathPrefix(`/`)"
      - "traefik.http.routers.homepage.entrypoints=websecure"
      - "traefik.http.routers.homepage.tls.certresolver=letsencrypt"
      - "traefik.http.services.homepage.loadbalancer.server.port=8081"

  zerotier:
    image: zerotier/zerotier:latest
    container_name: zerotier
    restart: unless-stopped
    network_mode: "host"
    cap_add:
      - NET_ADMIN
    devices:
      - /dev/net/tun
    volumes:
      - /var/lib/zerotier-one:/var/lib/zerotier-one
    command: ${ZEROTIER_NETWORK_ID}

  # mavlink2rest:
  #   build:
  #     context: ./mavlink2rest
  #     dockerfile: Dockerfile
  #     args:
  #       TARGET_ARCH: x86_64-unknown-linux-musl
  #   container_name: mavlink2rest
  #   restart: unless-stopped
  #   network_mode: "host"
  #   # Expose REST API and WebSocket on 8080 by default

  mavlink-server:
    build:
      context: ./mavlink-server
      dockerfile: Dockerfile
      args:
        TARGET_ARCH: x86_64-unknown-linux-musl
    container_name: mavlink-server
    restart: unless-stopped
    network_mode: "host"
    command: udpserver://0.0.0.0:14550 tcpserver://0.0.0.0:5777
    # Expose REST API and WebSocket on 8080 by default
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.mavlink-server.rule=Host(`${TRAEFIK_DOMAIN}`) && PathPrefix(`/mavlink-server`)"
      - "traefik.http.routers.mavlink-server.entrypoints=websecure"
      - "traefik.http.routers.mavlink-server.tls.certresolver=letsencrypt"
      - "traefik.http.services.mavlink-server.loadbalancer.server.port=8080"
      - "traefik.http.routers.mavlink-server-ws.rule=Host(`${TRAEFIK_DOMAIN}`) && PathPrefix(`/mavlink-server-ws`)"
      - "traefik.http.routers.mavlink-server-ws.entrypoints=websecure"
      - "traefik.http.routers.mavlink-server-ws.tls.certresolver=letsencrypt"
      - "traefik.http.routers.mavlink-server-ws.service=mavlink-server"

  mediamtx:
    image: bluenviron/mediamtx:latest
    container_name: mediamtx
    restart: unless-stopped
    network_mode: "host"
    privileged: true
    volumes:
      - ./mediamtx/mediamtx.yml:/mediamtx.yml:ro
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.mediamtx.rule=Host(`${TRAEFIK_DOMAIN}`) && PathPrefix(`/mediamtx`)"
      - "traefik.http.routers.mediamtx.entrypoints=websecure"
      - "traefik.http.routers.mediamtx.tls.certresolver=letsencrypt"
      - "traefik.http.services.mediamtx.loadbalancer.server.port=8889"

  mavlink-camera-manager:
    build:
      context: ./mavlink-camera-manager
      dockerfile: Dockerfile
      args:
        TARGET_ARCH: x86_64-unknown-linux-musl
    container_name: mavlink-camera-manager
    restart: unless-stopped
    network_mode: "host"
    privileged: true
    depends_on:
      - mediamtx
      - mavlink-server
    volumes:
      - ./mavlink-camera-manager/config:/mavlink/config
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.camera-manager.rule=Host(`${TRAEFIK_DOMAIN}`) && PathPrefix(`/camera-manager`)"
      - "traefik.http.routers.camera-manager.entrypoints=websecure"
      - "traefik.http.routers.camera-manager.tls.certresolver=letsencrypt"
      - "traefik.http.routers.camera-manager.service=camera-manager"
      - "traefik.http.services.camera-manager.loadbalancer.server.port=6020"
      - "traefik.http.routers.camera-manager-ws.rule=Host(`${TRAEFIK_DOMAIN}`) && PathPrefix(`/camera-manager-ws`)"
      - "traefik.http.routers.camera-manager-ws.entrypoints=websecure"
      - "traefik.http.routers.camera-manager-ws.tls.certresolver=letsencrypt"
      - "traefik.http.routers.camera-manager-ws.service=camera-manager-ws"
      - "traefik.http.services.camera-manager-ws.loadbalancer.server.port=6021"

  cockpit:
    image: bluerobotics/cockpit:latest
    container_name: cockpit
    restart: unless-stopped
    network_mode: "host"
    volumes:
      - ./cockpit-lite:/config
    environment:
      - COCKPIT_CONFIG=/config/config.json
    depends_on:
      - mavlink-server
      - mavlink-camera-manager
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.cockpit.rule=Host(`${TRAEFIK_DOMAIN}`) && PathPrefix(`/cockpit`)"
      - "traefik.http.routers.cockpit.entrypoints=websecure"
      - "traefik.http.routers.cockpit.tls.certresolver=letsencrypt"
      - "traefik.http.services.cockpit.loadbalancer.server.port=8080"

# All services share the zerotier network for secure VPN communication.
